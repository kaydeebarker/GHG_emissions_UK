---
title: "UK Greenhouse Gas Inventory"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#FFFFFF"
      fg: "#223022" 
      primary: "#96BC61"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: scroll
runtime: shiny
---

```{r load libraries, include=FALSE}
library(flexdashboard)
# Install thematic and un-comment for themed static plots (i.e., ggplot2)
# thematic::thematic_rmd()

##Create groups of libraries
datalibraries <- c("dplyr", "tidyverse", "janitor", "readxl", "readODS") #data reading and  manipulation
vislibraries <- c("ggplot2", "ggthemes", "RColorBrewer", "scales") #pretty plots
applibraries <- c("shiny", "plotly", "gridlayout", "bslib", "DT", "shinyWidgets") #libraries for app

##Install packages
#lapply(datalibraries, install.packages, character.only = TRUE)
#lapply(vislibraries, install.packages, character.only = TRUE)
#lapply(applibraries, install.packages, character.only = TRUE)
#devtools::install_github("rstudio/gridlayout") #install from github for this version of R

##Load libraries
lapply(datalibraries, library, character.only = TRUE)
lapply(vislibraries, library, character.only = TRUE)
lapply(applibraries, library, character.only = TRUE)
```

```{r global, include=FALSE}

##Map loop to download UK 2022 data from the UK Department for Energy Security and Net Zero
downloaded <- file.exists("UKGHG_2022.ods") #checks if file is downloaded in working directory
if(downloaded != T){ #if downloaded is not true
  map2("https://assets.publishing.service.gov.uk/media/65c0d54663a23d000dc821ca/final-greenhouse-gas-emissions-2022-by-source-dataset.ods", #update this link when new data available
       "UKGHG_2022.ods", download.file)} #else{print('data downloaded')} #name and download or print

##Read in ods file
GHG_UK22 <- read_ods(
  path = "UKGHG_2022.ods",
  sheet = 1, #define tab/sheet to read
  col_names = TRUE, #use header row for column names
  col_types = NULL, #guess data types
  na = "", #treat blank cells as NA
  skip = 0, #don't skip rows
  formula_as_formula = FALSE, #values only
  range = NULL, 
  row_names = FALSE, #no row names
  strings_as_factors = TRUE) %>% #use factors
  clean_names() %>% #clean column names to lowercase, with underscores
  separate_wider_delim(source, delim = " - ", #separate source, define delimiter as " - "
                       names = c("source_1", "source_2", "source_3"), #name new columns
                       too_few = "align_start", too_many = "merge", #what to do with fewer or more than 3
                       cols_remove = FALSE) %>% #keep original column
  separate_wider_delim(tes_category, delim = " - ", #separate category, define delimiter as " - "
                       names = c("category_1", "category_2"), #name new columns
                       too_few = "align_start", too_many = "merge", #what to do with fewer or more than 2
                       cols_remove = FALSE) %>% #keep original column
  separate_wider_delim(activity, delim = " - ", #separate activity, define delimiter as " - "
                       names = c("activity_1", "activity_2"), #name new columns
                       too_few = "align_start", too_many = "merge", #what to do with fewer or more than 2
                       cols_remove = FALSE) %>% #keep original column
  replace(is.na(.), "") #get rid of NA values, input blank

#Define custom color palette ####
colors <- c(
  "#3CBD9C", #transport
           "#F0A7CA", #buildings
           "#F0C954", #industry
           "#C24841", #electricity
           "#96BC61", #ag green
           "#5D7ED1", #lulucf blue
           "#D38744", #fuel
           "#A780BB"  #waste purple
)


colors_3lvls <- c(
  "#C24841", #CH4
           "#3CBD9C", #CO2
           "#F0C954"  #N2O
)


```

Sidebar {.sidebar}
======================================================================


### Filters

```{r}

pickerInput("select_GHG", #input name
            "GHG group", #display text
            choices = c("CO2","CH4","N2O","NF3","HFCs","PFCs","SF6"), 
            multiple = TRUE,
            options = list(`actions-box` = TRUE), #creates buttons
            selected = c("CO2","CH4","N2O","NF3","HFCs","PFCs","SF6") #initial values 
            )


sliderInput("select_Year", #input name
            label = "Year:", #display text
            min = 1991, max = 2022, 
            value = 2022, #initial value
            step = 1,
            sep = "") #remove commas


```

Select gases and year you would like to view to update the figures to the right.

Emissions are reported in megatonnes (Mt) of carbon dioxide (CO2) equivalents (eq.). 

Data from the [Department for Energy Security and Net Zero](https://www.data.gov.uk/dataset/9568363e-57e5-4c33-9e00-31dc528fcc5a/uk-greenhouse-gas-emissions-final).

High-Level View Across All Sectors {data-orientation=rows}
=======================================================================
Row
-----------------------------------------------------------------------
### GHG Emissions (Mt CO2 eq.)

```{r, error=FALSE, out.width = '70%'}

renderValueBox({

#Calculate total positive emissions
emissions <- GHG_UK22 %>%
  filter(emissions_mt_co2e >= "0") %>%
  filter(year == input$select_Year & ghg_grouped %in% input$select_GHG) %>%
  summarize(sum(emissions_mt_co2e, na.rm = TRUE)) %>%
  round(., 1) #1 digit after decimal

valueBox(emissions, 
         icon = "ion-fireball", color = "#C24841")

})


```

### Negative Emissions (Mt CO2 eq.)

```{r, error=FALSE,}

renderValueBox({
  
#Calculate total negative emissions
removals <- GHG_UK22 %>%
  filter(emissions_mt_co2e <= "0") %>%
  filter(year == input$select_Year & ghg_grouped %in% input$select_GHG) %>%
  summarize(sum(emissions_mt_co2e, na.rm = TRUE)) %>%
  round(., 1) #1 digit after decimal

valueBox(removals,
         icon = "ion-leaf", color = "#3CBD9C")

})

```

### Net Emissions (Mt CO2 eq.)

```{r, error=FALSE,}

renderValueBox({
  
#Calculate total emissions
net <- GHG_UK22 %>%
  filter(year == input$select_Year & ghg_grouped %in% input$select_GHG) %>%
  summarize(sum(emissions_mt_co2e, na.rm = TRUE)) %>%
  round(., 1) #1 digit after decimal

valueBox(net, 
         icon = "ion-load-a", color = "#F0C954")

})

```

Row {data-height=650}
-----------------------------------------------------------------------
### Greenhouse Gas (GHG) Emissions by Sector
Click a division within the pie to "zoom in" and view a further breakdown of that sector or category. Click the center to "zoom out" back towards the broader view. 
```{r, error=FALSE,}

produce_eplot <- shiny::reactive({
  
  ## Emissions data format for sunburst ####
  
  ## Apply filters
  GHG_pos <- GHG_UK22 %>%
    filter(year == input$select_Year & ghg_grouped %in% input$select_GHG) %>%
    filter(emissions_mt_co2e >= "0") #subset filter only positive values
  
  validate(
  need(input$select_GHG != "", "Insufficient data. Please change your selection on the left.")
  #need(!is.null(emissions_mt_co2e), "Insufficient data. Please change your selection on the left.")
  )
  
  ##Separate out variables summaries
  sectors <- GHG_pos %>%
    group_by(tes_sector) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))
  
  subsectors <- GHG_pos %>%
    group_by(tes_sector, tes_subsector) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))
  
  cat_2 <- GHG_pos %>%
    filter(category_2 != "") %>%
    group_by(tes_sector, tes_subsector, category_2) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
    unite('parents', c(tes_sector, tes_subsector), remove = TRUE, sep = " - ") #combine higher categories into parents
  
  cat_1 <- GHG_pos %>%
    group_by(tes_sector, tes_subsector, category_2, category_1) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
    mutate(parents = case_when(
      category_2 != "" ~str_c(tes_sector,tes_subsector,category_2, sep = " - "),
      category_2 == "" ~str_c(tes_sector,tes_subsector, sep = " - ")))
  
  act_1 <- GHG_pos %>%
    group_by(tes_sector, tes_subsector, category_2, category_1, activity_1) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
    mutate(parents = case_when(
      category_2 != "" ~str_c(tes_sector,tes_subsector,category_2, category_1, sep = " - "),
      category_2 == "" ~str_c(tes_sector,tes_subsector, category_1, sep = " - ")
    ))
  
  act_2 <- GHG_pos %>%
    filter(activity_2 != "") %>%
    group_by(tes_sector, tes_subsector, category_2, category_1, activity_1, activity_2) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
    mutate(parents = case_when(
      category_2 != "" ~str_c(tes_sector,tes_subsector,category_2, category_1, activity_1, sep = " - "),
      category_2 == "" ~str_c(tes_sector,tes_subsector, category_1, activity_1, sep = " - ")
    ))
  
  
  ##Now paste together distinct instances into dataframe with hierarchical structure - start simple, set root
  GHGsb1 <- data.frame(
    parents =c(rep("", 8)),
    labels =c(paste0(sectors$tes_sector)),
    values =as.numeric(c(paste0(sectors$Temissions)))
  )
  
  ##Add id column
  GHGsb1 <- GHGsb1 %>%
    mutate(ids = labels) 
  
  ##Now paste together distinct instances into dataframe with hierarchical structure - add on
  GHGsb2 <- data.frame(
    parents =c(paste0(subsectors$tes_sector), paste0(cat_2$parents), paste0(cat_1$parents), 
               paste0(act_1$parents), paste0(act_2$parents)),
    labels =c(paste0(subsectors$tes_subsector), paste0(cat_2$category_2), paste0(cat_1$category_1), 
              paste0(act_1$activity_1), paste0(act_2$activity_2)),
    values =as.numeric(c(paste0(subsectors$Temissions), paste0(cat_2$Temissions), paste0(cat_1$Temissions), paste0(act_1$Temissions), paste0(act_2$Temissions)))
  )
  
  ##Add id column                    
  GHGsb2 <- GHGsb2 %>%
    unite('ids', c(parents, labels), remove = FALSE, sep = " - ") #combine columns for id
  
  ##Combine into one dataframe
  GHGsb <- rbind(GHGsb1, GHGsb2) 
  
  
  ## Sunburst Emissions with Plotly ####
  sb <- plot_ly(GHGsb,
                type = 'sunburst',
                ids = ~ids,
                labels = ~labels,
                parents = ~parents,
                values = ~values,
                branchvalues = 'total', #parents are totals of children
                insidetextorientation='radial',
                maxdepth = 2, #how many levels to show
                level = "",
                sort = TRUE #sort by size #plot dimensions
  ) %>%
    layout(
      #margin = list(l = 10, r = 10, b = 10, t = 10),
      sunburstcolorway = colors,
      extendsunburstcolors = TRUE
    ) #%>%
    style(sb, hovertemplate="%{label} 
      %{value:,.3r} Mt CO2 equivalents
      %{percentParent:.1%} of %{parent} emissions
      <extra></extra>")
  
  #sb
  
  })

renderPlotly({produce_eplot()})

```

Row
-----------------------------------------------------------------------
### Negative CO2 Emissions (Removals)

```{r, error=FALSE,}

produce_rplot <- shiny::reactive({
  
  ## Removals data format for sunburst ####
  
  ##Apply filters
GHG_neg <- GHG_UK22 %>%
  filter(year == input$select_Year) %>%
  filter(emissions_mt_co2e <= "0") #subset filter only negative values

  ##Replace empty source 2 values with source 1
  GHG_neg$source_2[GHG_neg$source_2 == ""] <- NA #also works to replace blanks or any value defined here with NA across a dataframe
  GHG_neg$source_2[is.na(GHG_neg$source_2)] <- GHG_neg$source_1[is.na(GHG_neg$source_2)]
  
  ##Separate out variables summaries - all GHGs combined
  subsectors_neg <- GHG_neg %>%
    group_by(tes_subsector) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))
  
  cat_neg <- GHG_neg %>%
    group_by(tes_subsector, tes_category) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) 
  
  src_neg <- GHG_neg %>%
    group_by(tes_subsector, tes_category, source_2) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
    unite('parents', c(tes_subsector, tes_category), remove = TRUE, sep = " - ") #combine higher categories into parents
  
  
  ##Now paste together distinct instances into dataframe with hierarchical structure - start simple, set root
  GHGsb1_neg <- data.frame(
    parents =c(rep("", 6)),
    labels =c(paste0(subsectors_neg$tes_subsector)),
    values =as.numeric(c(paste0(subsectors_neg$Temissions)))
  )
  
  ##Add id column
  GHGsb1_neg <- GHGsb1_neg %>%
    mutate(ids = labels) 
  
  ##Now paste together distinct instances into dataframe with hierarchical structure - add on
  GHGsb2_neg <- data.frame(
    parents =c(paste0(cat_neg$tes_subsector), paste0(src_neg$parents)),
    labels =c(paste0(cat_neg$tes_category), paste0(src_neg$source_2)),
    values =as.numeric(c(paste0(cat_neg$Temissions), paste0(src_neg$Temissions)))
  )
  
  ##Add id column                    
  GHGsb2_neg <- GHGsb2_neg %>%
    unite('ids', c(parents, labels), remove = FALSE, sep = " - ") #combine columns for id
  
  ##Combine into one dataframe
  GHGsb_neg <- rbind(GHGsb1_neg, GHGsb2_neg) 
  
  ##Convert negative values to absolute (positive) values
  GHGsb_neg$values <- abs(GHGsb_neg$values)
  
  ## Sunburst Removals with Plotly ####
  sb_neg <- plot_ly(GHGsb_neg,
                    type = 'sunburst',
                    ids = ~ids,
                    labels = ~labels,
                    parents = ~parents,
                    values = ~values,
                    branchvalues = 'total', #parents are totals of children
                    insidetextorientation='radial',
                    maxdepth = 2, #how many levels to show
                    level = "",
                    sort = TRUE #sort by size
                    #width = 800, height = 800 #plot dimensions
  ) %>%
    layout(
      #margin = list(l = 10, r = 10, b = 10, t = 10),
      sunburstcolorway = c(
        "#3CBD9C", #forestry
                 "#F0C954", #grassland
                 "#5D7ED1", #peatland
                 "#C24841", #other
                 "#96BC61",
                 "#F0A7CA", 
                 "#D38744", 
                 "#A780BB"
      ),
      extendsunburstcolors = TRUE
    ) #%>%
    style(sb_neg, hovertemplate="%{label} 
      %{value:,.3r} Mt CO2 equivalents
      %{percentParent:.1%} of %{parent} removals
      <extra></extra>")
  
  #sb_neg
  })

plotly::renderPlotly({produce_rplot()})

```
### Time Series

```{r, error=FALSE,}

produce_tplot <- shiny::reactive({
  
  #Plot time series ggplot
  Sect_time <- GHG_UK22 %>%
    filter(ghg_grouped %in% input$select_GHG) %>%
    group_by(year, tes_sector) %>%
    summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
    rename("Sector" = "tes_sector") %>% #rename variable
    ggplot(aes(x=as.numeric(year), y=Temissions, color=Sector)) +
    geom_line() +
    xlab("") + ylab("Greenhouse Gas Emissions (Megatonnes CO2 eq.)") +
    ggtitle("Greenhouse Gas Emissions of the UK per Sector Over Time") +
    theme_few() +
    scale_y_continuous(labels = comma) +
    scale_x_continuous(breaks = pretty(c(1990:2020), n=6)) +
    scale_fill_manual(values = c("#96BC61", #ag green,
                                 "#F0A7CA", #buildings,
                                 "#3CBD9C", #transport
                                 "#C24841", #electricity
                                 "#D38744", #fuel
                                 "#F0C954", #industry
                                 "#5D7ED1", #lulucf blue
                                 "#A780BB"  #waste purple
           )) +
    theme(legend.position="bottom")
    
    #Make interactive with Plotly
    t_int <- plotly::ggplotly(Sect_time) %>% #convert to interactive graph
      layout(legend = list(
        orientation = "h")) #%>%
    style(t_int, hovertemplate="Year: %{x:,.r}
          CO2eq: %{y:,.4r} Mt") #define what hover label says, round x values, round y values to 4 sig. figs
    
    #t_int
  
  })


renderPlotly({produce_tplot()})


```

Row
-----------------------------------------------------------------------
### Data Summary

```{r}

renderTable({
  
  #Create filtered dataframe with columns for positive and negative emissions
  GHG_table <- GHG_UK22 %>%
    #filter(year == input$select_Year & ghg_grouped %in% input$select_GHG) %>%
    filter(year == "2022") %>%
    mutate(pos_e = ifelse(emissions_mt_co2e >= 0, emissions_mt_co2e, 0)) %>%
    mutate(neg_e = ifelse(emissions_mt_co2e <= 0, emissions_mt_co2e, 0)) %>%
    rename("Sector" = "tes_sector") %>% #rename variable
    rename("Subsector" = "tes_subsector") #rename variable
  
  #Summarize positive emissions
  GHG_postable <- GHG_table %>%
    group_by(Sector, Subsector) %>%
    summarize("Positive Emissions" = sum(pos_e, na.rm = TRUE))
  
  #Summarize negative emissions
  GHG_negtable <- GHG_table %>%
    group_by(Sector, Subsector) %>%
    summarize("Negative Emissions" = sum(neg_e, na.rm = TRUE))
  
  #Combine positive and negative into one table
  GHG_posneg <- inner_join(GHG_postable, GHG_negtable,
                       by= c('Sector', 'Subsector')) 
  
  #Summarize net emissions
  GHG_nettable <- GHG_table %>%
    group_by(Sector, Subsector) %>%
    summarize("Net Emissions" = sum(emissions_mt_co2e, na.rm = TRUE))
  
  #Combine into one summary table
  GHG_summary <- inner_join(GHG_posneg, GHG_nettable,
                       by= c('Sector', 'Subsector')) 
  
  #Round numbers
  #GHG_summary <- GHG_summary %>%
  #formatC("Positive Emissions", digits = 1, format = "f") %>%
  #formatC("Negative Emissions", digits = 1, format = "f") %>%
  #formatC("Net Emissions", digits = 1, format = "f")
  
  summary_rows <- nrow(GHG_summary)
  
  head(GHG_summary, n = summary_rows)
  
})

```


Defra Sector Graphs {data-orientation=rows}
=======================================================================

Row {.tabset .tabset-fade data-height=2000}
-------------------------------------
   
### Agriculture 

#### Agriculture Emissions by Subsector

```{r, error=FALSE,}

produce_agplot <- shiny::reactive({

#Bar plot by subsector, stacked by GHG with Plotly
agbar_int <- GHG_UK22 %>% 
  filter(tes_sector == "Agriculture") %>%
  group_by(tes_subsector, ghg, ghg_grouped) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
  pivot_wider(names_from = ghg_grouped, values_from=Temissions) %>%
  droplevels() %>%
  plot_ly(x = ~tes_subsector, type = 'bar', y = ~CO2, name = 'CO2', marker = list(color ="#3CBD9C")) %>%
  add_trace(y = ~CH4, name = 'CH4', marker = list(color ="#C24841")) %>%
  add_trace(y = ~N2O, name = 'N2O', marker = list(color ="#D38744")) %>%
  layout(yaxis = list(title = 'Emissions (Mt CO2 eq.)'), 
         barmode = 'stack'
         )

#Plotly customization
style(agbar_int, hovertemplate="Subsector: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

})

renderPlotly({produce_agplot()})


```   

#### Agriculture Emissions by Category

```{r, error=FALSE}

produce_agcatplot <- shiny::reactive({
  
#Bar plot by category, filled by subsector with Plotly
agcat_int <- GHG_UK22 %>% 
  filter(tes_sector == "Agriculture") %>%
  group_by(tes_subsector, tes_category) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
  droplevels() %>%
  plot_ly(x = ~tes_category, type = 'bar', y = ~Temissions, color = ~tes_subsector, colors = colors,
          marker = list(
            width = 1.5)) %>%
  layout(title = 'Agriculture Emissions by TES Subsector and Category',
         yaxis = list(title = 'Emissions (Mt CO2 eq.)'),
         xaxis = list(title = '', tickangle = -90),
         legend = list(x = 0.8, y = 1, orientation = 'v'),
         autosize = F, width = 1000, height = 600,
         autoexpand = T,
         barmode = 'group'
         )

#Plotly customization
style(agcat_int, 
hovertemplate="Category: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

})

renderPlotly({produce_agcatplot()})
  
```

### Land Use, Land Use Change, and Forestry

```{r}


```   

### Waste

```{r}


```   

