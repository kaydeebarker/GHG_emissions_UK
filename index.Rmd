---
title: "GHG Emissions of the UK"
author: "Kaydee S. Barker"
date: 'Feb. 2024'
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

rm(list=ls()) #clear global environment/workspace
knitr::opts_chunk$set(echo = FALSE, message = FALSE) #set echo and message to false universally
#knitr::knit(input = "GHG_UK.Rmd", output = "index.html")
#rmarkdown::render(input = "GHG_UK.Rmd", output_file = "index.html") #set name of knit file

```

```{r, message=FALSE}

library(readODS) #read ods files
library(readxl) #reads excel files
library(tidyverse) #Tidy packages
library(dplyr) #lots of functions - data manipulation
library(usethis) #look at and apply settings to Github actions
library(ggplot2) #pretty plots
library(ggthemes) #themes for ggplot
library(RColorBrewer) #color palettes
library(wesanderson) #color palettes from Wes Anderson films
library(scales) #axis formatting options
library(plotly) #interactive web graphs
library(networkD3) #interactive web network graphs
library(flipPlots) #plots (install with Github)

usethis::edit_r_environ() #set environment with Github token for API

```

## The National Atmospheric Emissions Inventory of the UK

Introduction to the inventory, with links
kilotonnes of CO2 equivalents


```{r, warning=FALSE}

# Map loop to download UK 2022 data from the UK Department for Energy Security and Net Zero
downloaded <- file.exists("UKGHG_2022.ods") #checks if file is downloaded in working directory
if(downloaded != T){ #if downloaded is not true
  map2("https://assets.publishing.service.gov.uk/media/65c0d54663a23d000dc821ca/final-greenhouse-gas-emissions-2022-by-source-dataset.ods", #update this link when new data available
                         "UKGHG_2022.ods", download.file)} #else{print('data downloaded')} #name and download or print


#Read in UK 2022 data from the UK Department for Energy Security and Net Zero
GHG_UK22 <- read_ods(
  path = "UKGHG_2022.ods",
  sheet = 1, #define tab/sheet to read
  col_names = TRUE, #use header row for column names
  col_types = NULL, #guess data types
  na = "", #treat blank cells as NA
  skip = 0, #don't skip rows
  formula_as_formula = FALSE, #values only
  range = NULL, 
  row_names = FALSE, #no row names
  strings_as_factors = TRUE) %>% #use factors
  rename("Subsector" = "TES Subsector") #rename variable

#Create dataframe with only categorization
GHG_categories <- GHG_UK22[, c(3,6:12)] %>%
  distinct() 

#IPCC code and TES subsectors - for categorization
GHG_IPCC_TES <- GHG_UK22[, c(3,6,7)] %>%
  distinct() %>%
  rename("IPCC_code" = "IPCC Code") #rename variable to match other df

# Map loop to download UK Regional data 1990-2021 from the UK National Atmospheric Emissions Inventory
downloaded2 <- file.exists("GHG_regions.xlsx") #checks if file is downloaded in working directory
if(downloaded2 != T){ #if downloaded is not true
  map2("https://uk-air.defra.gov.uk/reports/cat09/2306200930_DA_GHGI_1990-2021_Final_v3.1.xlsx", #update this link when new data available
                        "GHG_regions.xlsx", download.file)} #else{print('data downloaded')} #name and download or print

#Read in excel file, by source, with region
GHG_regions <- read_xlsx(
  "GHG_regions.xlsx", #excel file from current working directory
  sheet = "BySource_data", #define tab/sheet to read
  col_names = TRUE, #use header row for column names
  col_types = NULL, #guess data types
  na = "", #treat blank cells as NA
  trim_ws = TRUE, #trim any whitespace/unused columns and rows
  skip = 6, #skip 6 rows to get to pivot table data
  n_max = Inf, #set maximum number of rows to include
  guess_max = min(1000, Inf), #how many rows to use to guess data types
  progress = readxl_progress(), #display progress in reading in data
  .name_repair = "unique" #makes sure all column names not empty or duplicated
)

#Add subsector into GHG_regions, match format 
GHG_regions2 <- inner_join(GHG_IPCC_TES, GHG_regions,
	by='IPCC_code') %>% #use inner join to combine dataframes by a shared variable
  rename("GHG" = "Pollutant") %>% #rename variable to match UK only csv
  rename("NC_Sector" = "NCFormat") %>% #rename variable
  rename("TES_Sector" = "TES Sector") #rename variable

#Simplify regional dataset
GHG_simp <- GHG_regions2 %>%
  group_by(EmissionYear, TES_Sector, Subsector, RegionName, GHG) %>%
  summarize(Temissions = sum(Emission, na.rm = TRUE)) %>%
  rename("Sector" = "TES_Sector")

#2021 only
GHG_2021 <- GHG_simp %>%
    filter(EmissionYear == "2021") #filter to only 2021

#Grouped into all of UK
GHG_2021_joined <- GHG_2021 %>%
  group_by(Sector, Subsector, GHG) %>%
  summarize(Temissions = sum(Temissions, na.rm = TRUE))

```

## Visualization at High Level

```{r, warning=FALSE}

#Define custom color palette
colors <- paste(c('#40004b','#67001f','#b2182b','#dfc27d','#f6e8c3','#fddbc7','#fde0ef',
                  '#FF7E70','#2852A8','#DBB96E','#786EDB','#BD9DAC','#9C9075','#01665e','#6EDB93',
                  '#FF9C91','#FFD4E8','#CC995E','#FF8F99','#80AAFF',
                  '#6EDB70','#948B76','#D4B0C0','#BD5E53','#708670',
                  '#3D7EFF','#A496FF','#8C80DA','#62B2B5','#9E002F',
                  '#D90041','#FF2949','#58B059','#448745','#F5CE7A',
                  '#FFBF76','#7BE1E5','#7CF77E','#D4C39F','#FFEBBF','#536353'), collapse = '", "')

colorJS <- paste('d3.scaleOrdinal(["', colors, '"])') #format to call Javascript D3

```


### Sankey Diagram

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating proportional breakdown of greenhouse gas emissions in the UK in 2021. From left to right, greenhouse gas by sector by subsector. Proportions based on kilotonnes of CO2 equivalents."}

#Set up Sankey links dataframe - from sector to subsector to GHGs
links <- data.frame(source=c(paste0(GHG_2021_joined$Sector), paste0(GHG_2021_joined$Subsector)), 
                    target=c(paste0(GHG_2021_joined$Subsector), paste0(GHG_2021_joined$GHG)),
                    value=as.numeric(paste0(GHG_2021_joined$Temissions)))

links <- links[-c(83:85),] #remove instances with repeat name

#Create nodes df from names in links df
nodes <- data.frame(
  name=unique(c(as.character(links$source), 
  as.character(links$target))))

#Add ID numbers
links$IDsource <- as.numeric(match(links$source, nodes$name)-1)
links$IDtarget <- as.numeric(match(links$target, nodes$name)-1)

#Set up Sankey links dataframe - breakdown from GHGs to sectors to subsectors
links2 <- data.frame(source=c(paste0(GHG_2021_joined$GHG), paste0(GHG_2021_joined$Sector)), 
                    target=c(paste0(GHG_2021_joined$Sector), paste0(GHG_2021_joined$Subsector)),
                    value=as.numeric(paste0(GHG_2021_joined$Temissions))) 

links2 <- links2[-c(168:170),] #remove instances with repeat name

#Create nodes df from names in links df
nodes2 <- data.frame(
  name=unique(c(as.character(links2$source), 
  as.character(links2$target))))

#Add ID numbers
links2$IDsource <- as.numeric(match(links2$source, nodes2$name)-1)
links2$IDtarget <- as.numeric(match(links2$target, nodes2$name)-1)

#Plot with networkD3
sankey <- sankeyNetwork(Links = links2, Nodes = nodes2, #dataframes to use
              Source = "IDsource", Target = "IDtarget", #numeric identifiers of variables
              Value = "value", #numeric weights
							NodeID = "name", #node labels
              units = "kt CO2 eq.", #label units
							colourScale = colorJS,
							fontSize = 7,
              sinksRight=FALSE, #justify last variables right if true
							nodePadding = 8, #vertical space between nodes
              iterations = 10) #number of times for it to try to find the best order and format

sankey #view plot


```


```{r, eval=FALSE, include=FALSE}

#Plot with Plotly
sankey3 <- plot_ly(type = "sankey",
                   domain = list(x =  c(0,1),y =  c(0,1)),
                   orientation = "h",
                   valueformat = ".0f",
                   valuesuffix = "kt CO2 eq.",
      node = list(
        label = nodes$name,
        pad = 15,
        thickness = 20,
        line = list(color = "black", width = 0.5),
      link = list(
        source = links$IDsource,
        target = links$IDtarget,
        value = links$value
        #label = linklist$label
        ))) %>% 
  layout(
    title = "Greenhouse Gas Emissions Per Sector in the UK",
    font = list(size = 10),
    xaxis = list(showgrid = F, zeroline = F),
    yaxis = list(showgrid = F, zeroline = F))

sankey3


```


### Time Series Graph of Emissions by Sector

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK over time, by sector."}

#Plot time series
Sect_time <- GHG_regions2 %>%
  group_by(EmissionYear, TES_Sector) %>%
  summarize(Temissions = sum(Emission, na.rm = TRUE)) %>%
  rename("Sector" = "TES_Sector") %>%
ggplot(aes(x=as.numeric(EmissionYear), y=Temissions, color=Sector)) +
  geom_line() +
  xlab("") + ylab("Greenhouse Gas Emissions (kilotonnes CO2 eq.)") +
  ggtitle("Greenhouse Gas Emissions of the UK per Sector Over Time") +
  theme_few() +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = pretty(c(1990:2020), n=6)) +
  scale_color_brewer(palette = "Set2") +
  theme(legend.position="bottom")

#Sect_time #view ggplot

#Make interactive with Plotly
t_int <- ggplotly(Sect_time) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(t_int, hovertemplate="Year: %{x:,.r}
CO2eq: %{y:,.4r} kt") #define what hover label says, round x values, round y values to 4 sig. figs


```


## Sector and Subsector Summaries

### Agriculture

```{r, warning=FALSE}

ag_df <- GHG_regions2 %>%
  filter(TES_Sector == "Agriculture") %>% #filter sector
  filter(EmissionYear == "2021") %>% #filter to only 2021 
  group_by(Subsector, IPCC_name, GHG, IPCC_code) %>%
  summarize(Temissions = sum(Emission, na.rm = TRUE))
ag_df$IPCC_name <- gsub('_', ' ', ag_df$IPCC_name) #replace underscores with spaces to make nicer to read

#wide - split GHGs
agwideGHG <- ag_df %>%
  pivot_wider(names_from = GHG, values_from=Temissions) %>%
  replace(is.na(.), 0)

```

#### Agriculture Sankey Diagram
```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's agricultural sector in 2021. From left to right, greenhouse gas by subsector by individual source, following IPCC source names."}

#Set up Sankey links dataframe
aglinks <- data.frame(source=c(paste0(ag_df$GHG), paste0(ag_df$Subsector)), 
                    target=c(paste0(ag_df$Subsector), paste0(ag_df$IPCC_name)),
                    value=as.numeric(paste0(ag_df$Temissions)))

#Create nodes df from names in links df
agnodes <- data.frame(
  name=unique(c(as.character(aglinks$source), 
  as.character(aglinks$target))))

#Add ID numbers
aglinks$IDsource <- as.numeric(match(aglinks$source, agnodes$name)-1)
aglinks$IDtarget <- as.numeric(match(aglinks$target, agnodes$name)-1)


#Plot with networkD3
agsankey <- sankeyNetwork(Links = aglinks, Nodes = agnodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "kilotonnes CO2 eq.",
              sinksRight=FALSE, nodePadding = 8,
              iterations = 5)

agsankey

```

#### Agriculture Breakdown Graphs

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Doughnut charts of the UK's agriculture greenhouse gas emissions by greenhouse gas identity and subsector in 2021."}

agpie <- ag_df %>% plot_ly(textinfo = 'label', insidetextorientation='horizontal') %>%
  add_pie(labels = ~GHG, values = ~Temissions, hole = 0.6, domain = list(row = 0, column = 0)) %>% 
  add_pie(labels = ~Subsector, values = ~Temissions, hole = 0.6, domain = list(row = 0, column = 2)) %>% 
  layout(title = "Emissions by Greenhouse Gas Identity and Subsector",  showlegend = F,
         #annotations = list(list(x = 0.20 , y = 1, text = "Emissions by Greenhouse Gas Identity"), 
          #                  list(x = 0.80 , y = 1, text = "Emissions by Subsector")),
         grid=list(rows=1, columns=3),
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE)) 

style(agpie, hovertemplate="%{label} 
      Emissions: %{value:,.4r} kt CO2 eq.
      %{percent}
      <extra></extra>")

```


```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK's agricultural sector in 2021 by subsector, colored by greenhouse gas identity."}

#Bar plot by subsector, stacked by GHG
agbar <- ggplot(ag_df, aes(x = Subsector, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  xlab("Subsector") + ylab("Emissions (kt CO2 eq.)") #define/change X and Y labels

#Make interactive with Plotly
agbar_int <- ggplotly(agbar) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(agbar_int, hovertemplate="Subsector: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```


```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK's agricultural sector in 2021 by source, colored by subsector."}

#Bar plot by source
agsource <- ggplot(ag_df, aes(x = IPCC_name, y = Temissions, fill = Subsector)) + 
  geom_bar(stat = "identity", width = 0.7, position = "dodge") + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Agriculture emissions in 2021") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="top", legend.box = "horizontal",
        text=element_text(size=10, colour = "black"), axis.text.x=element_blank())
#axis.text.x = element_text(size=8, colour = "black")

#Make interactive with Plotly
agsource_int <- ggplotly(agsource) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agsource_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK's agricultural sector in 2021 by IPCC code, colored by subsector and grouped by greenhouse gas identity."}

#Plot GHGs into side-by-side plots with Plotly
ag_CO2 <- agwideGHG %>% 
  plot_ly(x = ~IPCC_name, y = ~CO2, color = ~Subsector, type = 'bar', legendgroup = ~Subsector) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

ag_CH4 <- agwideGHG %>% 
  plot_ly(x = ~IPCC_name, y = ~CH4, color = ~Subsector, type = 'bar', legendgroup = ~Subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

ag_N2O <- agwideGHG %>% 
  plot_ly(x = ~IPCC_name, y = ~N2O, color = ~Subsector, type = 'bar', legendgroup = ~Subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

ag_GHGs <- subplot(ag_CO2, ag_CH4, ag_N2O, shareY = FALSE, margin = 0.05) %>%
  layout(title = list(text = "UK's Agriculture Emissions in 2021", pad = list(t=50, b = 50)),
         yaxis = list(title = 'Emissions (kt CO2 equivalents)'), 
         plot_bgcolor='#e5ecf6',
         legend = list(orientation = "h", title=list(text='<b>Subsector</b>')),
         annotations = list(list(
           x = 0.125,  y = 1.0,
           text = "CO2",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.5,  y = 1.0,
           text = "CH4",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.875,  y = 1.0,
           text = "N2O",  
           xref = "paper",
           yref = "paper", 
           showarrow = FALSE)))

#Plotly customization
style(ag_GHGs, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs


```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the agricultural combustion subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot combustion, stacked by GHG
agcom <- ag_df %>%
  filter(Subsector == "Agricultural combustion") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Agricultural Combustion") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agcom_int <- ggplotly(agcom) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agcom_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the agricultural soils subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot soils, stacked by GHG
agsoil <- ag_df %>%
  filter(Subsector == "Agricultural soils") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Agricultural Soils") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agsoil_int <- ggplotly(agsoil) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agsoil_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs


```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the livestock subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot livestock, stacked by GHG
agls <- ag_df %>%
  filter(Subsector == "Livestock") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Livestock") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agls_int <- ggplotly(agls) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agls_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the agricultural 'other' subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot other ag, stacked by GHG
agother <- ag_df %>%
  filter(Subsector == "Other agriculture") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Other Agriculture") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agother_int <- ggplotly(agother) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agother_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs
  
```


### LULUCF

Note - possibly some replicate data or miscategorization - need to clean up the data for this section.

```{r, warning=FALSE}

LULUCF <- GHG_regions2 %>%
  filter(TES_Sector == "LULUCF") %>% #filter sector
  filter(EmissionYear == "2021") %>% #filter to only 2021 
  group_by(Subsector, IPCC_name, GHG, IPCC_code) %>%
  summarize(Temissions = sum(Emission, na.rm = TRUE)) 
LULUCF$IPCC_name <- gsub('_', ' ', LULUCF$IPCC_name) #replace underscores with spaces to make nicer to read

#wide - split GHGs
LULUCFwideGHG <- LULUCF %>%
  pivot_wider(names_from = GHG, values_from=Temissions) %>%
  replace(is.na(.), 0)

```

#### LULUCF Sankey Diagram
```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's LULUCF sector in 2021. From left to right, greenhouse gas by subsector by individual source, following IPCC source names."}

#Set up Sankey links dataframe
LULUCFlinks <- data.frame(source=c(paste0(LULUCF$GHG), paste0(LULUCF$Subsector)), 
                    target=c(paste0(LULUCF$Subsector), paste0(LULUCF$IPCC_name)),
                    value=as.numeric(paste0(LULUCF$Temissions)))

#Create nodes df from names in links df
LULUCFnodes <- data.frame(
  name=unique(c(as.character(LULUCFlinks$source), 
  as.character(LULUCFlinks$target))))

#Add ID numbers
LULUCFlinks$IDsource <- as.numeric(match(LULUCFlinks$source, LULUCFnodes$name)-1)
LULUCFlinks$IDtarget <- as.numeric(match(LULUCFlinks$target, LULUCFnodes$name)-1)


#Plot with networkD3
LULUCFsankey <- sankeyNetwork(Links = LULUCFlinks, Nodes = LULUCFnodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "kilotonnes CO2 eq.",
              sinksRight=TRUE, nodePadding = 30,
              iterations = 50)

LULUCFsankey

```

#### LULUCF Breakdown Graphs


```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK's LULUCF sector in 2021 by subsector, colored by greenhouse gas identity."}

#Bar plot by subsector, stacked by GHG
LULUCFbar <- ggplot(LULUCF, aes(x = Subsector, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  xlab("Subsector") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(axis.text.x=element_blank())

#Make interactive with Plotly
LULUCFbar_int <- ggplotly(LULUCFbar) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(LULUCFbar_int, hovertemplate="Subsector: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs


```


```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK's LULUCF sector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot by source with Plotly
LULUCFsource <- LULUCFwideGHG %>% 
  plot_ly(x = ~IPCC_name, y = ~CO2, type = 'bar', name = 'CO2') %>% 
  add_trace(y = ~CH4, name = 'CH4') %>%
  add_trace(y = ~N2O, name = 'N2O') %>%
  layout(barmode = 'stack', 
         title = list(text = "UK's LULUCF Emissions in 2021", pad = list(t=50, b=50)),
         yaxis = list(title = 'Emissions (kt CO2 equivalents)'),
         xaxis = list(title = 'Source', showticklabels=FALSE))
         #legend = list(orientation = "h", title=list(text='<b>Subsector</b>')))

#Plotly customization
style(LULUCFsource, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") 

```

```{r, message=FALSE, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK's LULUCF sector in 2021 by source, colored by subsector and grouped by greenhouse gas identity."}

#Plot GHGs into side-by-side plots with Plotly
LULUCF_CO2 <- LULUCFwideGHG %>% 
  plot_ly(x = ~IPCC_name, y = ~CO2, color = ~Subsector, type = 'bar', legendgroup = ~Subsector) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

LULUCF_CH4 <- LULUCFwideGHG %>% 
  plot_ly(x = ~IPCC_name, y = ~CH4, color = ~Subsector, type = 'bar', legendgroup = ~Subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

LULUCF_N2O <- LULUCFwideGHG %>% 
  plot_ly(x = ~IPCC_name, y = ~N2O, color = ~Subsector, type = 'bar', legendgroup = ~Subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

LULUCF_GHGs <- subplot(LULUCF_CO2, LULUCF_CH4, LULUCF_N2O, shareY = FALSE, margin = 0.05) %>%
  layout(title = list(text = "UK's LULUCF Emissions in 2021", pad = list(t=50, b = 50)),
         yaxis = list(title = 'Emissions (kt CO2 equivalents)'), 
         plot_bgcolor='#e5ecf6',
         legend = list(orientation = "h", title=list(text='<b>Subsector</b>')),
         annotations = list(list(
           x = 0.125,  y = 1.0,
           text = "CO2",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.5,  y = 1.0,
           text = "CH4",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.875,  y = 1.0,
           text = "N2O",  
           xref = "paper",
           yref = "paper", 
           showarrow = FALSE)))

#Plotly customization
style(LULUCF_GHGs, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the bioenergy crops subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
biocrops <- LULUCF %>%
  filter(Subsector == "Bioenergy crops") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Bioenergy Crops") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
biocrops_int <- ggplotly(biocrops) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(biocrops_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the cropland mineral soils change subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
cropsoilchg <- LULUCF %>%
  filter(Subsector == "Cropland mineral soils change") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Cropland Mineral Soils Change") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
cropsoilchg_int <- ggplotly(cropsoilchg) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(cropsoilchg_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the grassland mineral soils change subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
grsoilchg <- LULUCF %>%
  filter(Subsector == "Grassland mineral soils change") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Grassland Mineral Soils Change") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
grsoilchg_int <- ggplotly(grsoilchg) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(grsoilchg_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the forestry subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
forestry <- LULUCF %>%
  filter(Subsector == "Forestry") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Forestry") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
forestry_int <- ggplotly(forestry) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(forestry_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the peatland subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
peat <- LULUCF %>%
  filter(Subsector == "Peatland") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Peatland") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
peat_int <- ggplotly(peat) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(peat_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the settlement subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
settle <- LULUCF %>%
  filter(Subsector == "Settlement") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Settlement") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
settle_int <- ggplotly(settle) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(settle_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the 'other' LULUCF subsector in 2021 by source, colored by greenhouse gas identity."}

#Bar plot other ag, stacked by GHG
Lother <- LULUCF %>%
  filter(Subsector == "Other LULUCF") %>%
ggplot(aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2021: Other LULUCF") + #add a graph title
  xlab("") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
Lother_int <- ggplotly(Lother) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(Lother_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs
  
```

### Waste

```{r, warning=FALSE}

waste_df <- GHG_regions2 %>%
  filter(TES_Sector == "Waste") %>% #filter sector
  filter(EmissionYear == "2021") %>% #filter to only 2021 
  group_by(Subsector, IPCC_name, GHG, IPCC_code) %>%
  summarize(Temissions = sum(Emission, na.rm = TRUE)) 
waste_df$IPCC_name <- gsub('_', ' ', waste_df$IPCC_name) #replace underscores with spaces to make nicer to read

#wide - split GHGs
waste_wideGHG <- waste_df %>%
  pivot_wider(names_from = GHG, values_from=Temissions) %>%
  replace(is.na(.), 0)

```

#### Waste Sankey Diagram
```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's buildings and product uses sector in 2021. From left to right, greenhouse gas by subsector by individual source, following IPCC source names."}

#Set up Sankey links dataframe
wastelinks <- data.frame(source=c(paste0(waste_df$GHG), paste0(waste_df$Subsector)), 
                    target=c(paste0(waste_df$Subsector), paste0(waste_df$IPCC_name)),
                    value=as.numeric(paste0(waste_df$Temissions)))

#Create nodes df from names in links df
wastenodes <- data.frame(
  name=unique(c(as.character(wastelinks$source), 
  as.character(wastelinks$target))))

#Add ID numbers
wastelinks$IDsource <- as.numeric(match(wastelinks$source, wastenodes$name)-1)
wastelinks$IDtarget <- as.numeric(match(wastelinks$target, wastenodes$name)-1)


#Plot with networkD3
wastesankey <- sankeyNetwork(Links = wastelinks, Nodes = wastenodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "kilotonnes CO2 eq.",
              sinksRight=FALSE, nodePadding = 35,
              iterations = 45)

wastesankey

```

#### Waste Breakdown Graphs

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Doughnut charts of the UK's waste greenhouse gas emissions by greenhouse gas identity and subsector in 2021."}

wastepie <- waste_df %>% plot_ly(textinfo = 'label', insidetextorientation='horizontal') %>%
  add_pie(labels = ~GHG, values = ~Temissions, hole = 0.6, domain = list(row = 0, column = 0)) %>% 
  add_pie(labels = ~IPCC_name, values = ~Temissions, hole = 0.6, domain = list(row = 0, column = 2)) %>% 
  layout(title = "Emissions by Greenhouse Gas Identity and Subsector",  showlegend = F,
         #annotations = list(list(x = 0.20 , y = 1, text = "Emissions by Greenhouse Gas Identity"), 
          #                  list(x = 0.80 , y = 1, text = "Emissions by Subsector")),
         grid=list(rows=1, columns=3),
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE)) 

style(wastepie, hovertemplate="%{label} 
      Emissions: %{value:,.4r} kt CO2 eq.
      %{percent}
      <extra></extra>")

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in kilotonnes of CO2 equivalents in the UK's waste sector in 2021 by subsector, colored by greenhouse gas identity."}

#Bar plot by subsector, stacked by GHG
wastebar <- ggplot(waste_df, aes(x = IPCC_name, y = Temissions, fill = GHG)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  xlab("Source") + ylab("Emissions (kt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="top", legend.box = "horizontal",
        text=element_text(size=10, colour = "black"), axis.text.x=element_blank())

#Make interactive with Plotly
wastebar_int <- ggplotly(wastebar) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(wastebar_int, hovertemplate="Source: %{x}
Emissions: %{y:,.4r} kt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```



### Buildings and product uses

```{r, warning=FALSE}

build_df <- GHG_regions2 %>%
  filter(TES_Sector == "Buildings and product uses") %>% #filter sector
  filter(EmissionYear == "2021") %>% #filter to only 2021 
  group_by(Subsector, IPCC_name, GHG, IPCC_code) %>%
  summarize(Temissions = sum(Emission, na.rm = TRUE)) 
build_df$IPCC_name <- gsub('_', ' ', build_df$IPCC_name) #replace underscores with spaces to make nicer to read

#wide - split GHGs
build_wideGHG <- build_df %>%
  pivot_wider(names_from = GHG, values_from=Temissions) %>%
  replace(is.na(.), 0)

```

#### Buildings and Products Sankey Diagram
```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's buildings and product uses sector in 2021. From left to right, greenhouse gas by subsector by individual source, following IPCC source names."}

#Set up Sankey links dataframe
buildlinks <- data.frame(source=c(paste0(build_df$GHG), paste0(build_df$Subsector)), 
                    target=c(paste0(build_df$Subsector), paste0(build_df$IPCC_name)),
                    value=as.numeric(paste0(build_df$Temissions)))

#Create nodes df from names in links df
buildnodes <- data.frame(
  name=unique(c(as.character(buildlinks$source), 
  as.character(buildlinks$target))))

#Add ID numbers
buildlinks$IDsource <- as.numeric(match(buildlinks$source, buildnodes$name)-1)
buildlinks$IDtarget <- as.numeric(match(buildlinks$target, buildnodes$name)-1)


#Plot with networkD3
buildsankey <- sankeyNetwork(Links = buildlinks, Nodes = buildnodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "kilotonnes CO2 eq.",
              sinksRight=FALSE, nodePadding = 15,
              iterations = 15)

buildsankey

```

