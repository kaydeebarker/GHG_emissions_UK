---
title: "GHG Emissions of the UK"
author: "Kaydee S. Barker"
date: 'Feb. 2024'
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

rm(list=ls()) #clear global environment/workspace
knitr::opts_chunk$set(echo = FALSE, message = FALSE) #set echo and message to false universally
#knitr::knit(input = "GHG_UK.Rmd", output = "index.html")
#rmarkdown::render(input = "GHG_UK.Rmd", output_file = "index.html") #set name of knit file

```

```{r load libraries, message=FALSE}

library(readODS) #read ods files
library(readxl) #reads excel files
library(tidyverse) #Tidy packages
library(dplyr) #lots of functions - data manipulation
library(janitor) #helps with data cleaning
library(usethis) #look at and apply settings to Github actions
#library(data.tree) #transform df or file to data tree
library(ggplot2) #pretty plots
library(ggthemes) #themes for ggplot
library(RColorBrewer) #color palettes
library(wesanderson) #color palettes from Wes Anderson films
library(scales) #axis formatting options
library(plotly) #interactive web graphs
library(networkD3) #interactive web network graphs
library(d3r) #make hierarchical json
library(sunburstR) #sunburst
library(htmltools) #display via html

#usethis::edit_r_environ() #set environment with Github token for API


```

## The National Atmospheric Emissions Inventory of the UK

Introduction to the inventory, with links megatonnes of CO2 equivalents Territorial Emissions Statistics (TES) sectors and subsectors used, as they are replacing National Communications (NC) sectors and subsectors in all reports (<https://www.gov.uk/government/statistics/final-uk-greenhouse-gas-emissions-national-statistics-1990-to-2022>)

```{r load data, warning=FALSE}

#Map loop to download UK 2022 data from the UK Department for Energy Security and Net Zero
downloaded <- file.exists("UKGHG_2022.ods") #checks if file is downloaded in working directory
if(downloaded != T){ #if downloaded is not true
  map2("https://assets.publishing.service.gov.uk/media/65c0d54663a23d000dc821ca/final-greenhouse-gas-emissions-2022-by-source-dataset.ods", #update this link when new data available
                         "UKGHG_2022.ods", download.file)} #else{print('data downloaded')} #name and download or print

#Read in ods file
GHG_UK22 <- read_ods(
  path = "UKGHG_2022.ods",
  sheet = 1, #define tab/sheet to read
  col_names = TRUE, #use header row for column names
  col_types = NULL, #guess data types
  na = "", #treat blank cells as NA
  skip = 0, #don't skip rows
  formula_as_formula = FALSE, #values only
  range = NULL, 
  row_names = FALSE, #no row names
  strings_as_factors = TRUE) %>% #use factors
  clean_names() %>% #clean column names to lowercase, with underscores
  separate_wider_delim(source, delim = " - ", #separate source, define delimiter as " - "
                       names = c("source_1", "source_2", "source_3"), #name new columns
                       too_few = "align_start", too_many = "merge", #what to do with fewer or more than 3
                       cols_remove = FALSE) %>% #keep original column
  separate_wider_delim(tes_category, delim = " - ", #separate category, define delimiter as " - "
                       names = c("category_1", "category_2"), #name new columns
                       too_few = "align_start", too_many = "merge", #what to do with fewer or more than 2
                       cols_remove = FALSE) %>% #keep original column
  separate_wider_delim(activity, delim = " - ", #separate activity, define delimiter as " - "
                       names = c("activity_1", "activity_2"), #name new columns
                       too_few = "align_start", too_many = "merge", #what to do with fewer or more than 2
                       cols_remove = FALSE) %>% #keep original column
  replace(is.na(.), "") #get rid of NA values, input blank


#Map loop to download UK sector mapping data
downloaded2 <- file.exists("UKsectors.xlsx") #checks if file is downloaded in working directory
if(downloaded2 != T){ #if downloaded is not true
  map2("https://assets.publishing.service.gov.uk/media/65c0d392c4319100141a455d/ghg-statistics-tes-to-nc-sector-mapping-2022.xlsx", #update this link when new data available
                         "UKsectors.xlsx", download.file)} #else{print('data downloaded')} #name and download or print

#Read in excel file
UKsectors <- read_xlsx(
  "UKsectors.xlsx", #excel file from current working directory
  sheet = "Table 1", #define tab/sheet to read
  col_names = FALSE, #the format of this excel file doesn't allow headers to be column names
  col_types = NULL, #guess data types
  na = "", #treat blank cells as NA
  trim_ws = TRUE, #trim any whitespace/unused columns and rows
  skip = 6, #skip 6 rows to get to pivot table data
  n_max = Inf, #set maximum number of rows to include
  guess_max = min(1000, Inf), #how many rows to use to guess data types
  progress = readxl_progress(), #display progress in reading in data
  .name_repair = "unique" #makes sure all column names not empty or duplicated
) 

#Assign headers/column names for UK sectors dataframe (doesn't import with headers)
colnames(UKsectors) <- c("ipcc_code", "source", "activity", "nc_sector", "nc_subsector", "nc_category", 
                         "tes_sector", "tes_subsector", "tes_category") 

#Assign more specific codes than IPCC codes
UKsectors <- UKsectors %>%
  mutate(subcode = case_when(tes_subsector == "Bioenergy crops" ~ "a", #create a subcode for LULUCF subsectors
                             tes_subsector == "Cropland mineral soils change" ~ "b",
                             tes_subsector == "Forestry" ~ "c",
                             tes_subsector == "Grassland mineral soils change" ~ "d",
                             tes_subsector == "Peatland" ~ "e",
                             tes_subsector == "Settlement" ~ "f",
                             tes_subsector == "Other LULUCF" ~ "g",
                             .default = "")) %>%
  unite('ipcc_code2', c(ipcc_code, subcode), remove = FALSE, sep = "_") #combine IPCC code with subcode


IPCC_TES <- UKsectors[, c(1,2,8,9,10)] #dataframe with just IPCC codes and TES sectors, subsectors, and categories




#Map loop to download UK Regional data 1990-2022 from the UK National Atmospheric Emissions Inventory
downloaded3 <- file.exists("GHG_regions.xlsx") #checks if file is downloaded in working directory
if(downloaded3 != T){ #if downloaded is not true
  map2("https://uk-air.defra.gov.uk/reports/cat09/2306200930_DA_GHGI_1990-2022_Final_v3.1.xlsx", #update this link when new data available
                        "GHG_regions.xlsx", download.file)} #else{print('data downloaded')} #name and download or print

#Read in excel file, by source, with region
GHG_regions <- read_xlsx(
  "GHG_regions.xlsx", #excel file from current working directory
  sheet = "BySource_data", #define tab/sheet to read
  col_names = TRUE, #use header row for column names
  col_types = NULL, #guess data types
  na = "", #treat blank cells as NA
  trim_ws = TRUE, #trim any whitespace/unused columns and rows
  skip = 6, #skip 6 rows to get to pivot table data
  n_max = Inf, #set maximum number of rows to include
  guess_max = min(1000, Inf), #how many rows to use to guess data types
  progress = readxl_progress(), #display progress in reading in data
  .name_repair = "unique" #makes sure all column names not empty or duplicated
) %>%
  clean_names() %>% #clean column names to lowercase, with underscores
  separate_wider_delim(source_name, delim = " - ", #separate source, define delimiter as " - "
                       names = c("source_1", "source_2", "source_3"), #name new columns
                       too_few = "align_start", too_many = "merge", #what to do with fewer or more than 3
                       cols_remove = FALSE) #keep original column

GHG_regions$ipcc_name <- gsub('_', ' ', GHG_regions$ipcc_name) #replace string underscores with spaces

#Look at distinct instances of codes and categories in regional dataset
GHG_codes <- GHG_regions[, c(5:9)] %>%
  distinct()

#Assign more specific codes than IPCC codes
#LULUCF TES Subsectors search strings
Bioenergy <- c("Bioenergy crops", "Miscanthus", "coppice")
Cropland <- c("Remaining Cropland", "converted to Cropland")
Forestry <- c("remaining Forest Land", "converted to Forest Land", "converted from forest land", "Harvested Wood")
Grassland <- c("Remaining Grassland", "converted to Grassland")
Peatland <- c("drain", "wet", "peat")
Settlement <- c("converted to settlement")
O_LULUCF <- c("Biomass Burning","carbon stock change")

#Assign codes from strings
GHG_regions <- GHG_regions %>%
  mutate(subcode = case_when(grepl(paste(Bioenergy, collapse='|'), source_name, ignore.case = TRUE) ~ "a", #for LULUCF
                             grepl(paste(Cropland, collapse='|'), source_name, ignore.case = TRUE) ~ "b",
                             grepl(paste(Forestry, collapse='|'), source_name, ignore.case = TRUE) ~ "c",
                             grepl(paste(Grassland, collapse='|'), source_name, ignore.case = TRUE) ~ "d",
                             grepl(paste(Peatland, collapse='|'), source_name, ignore.case = TRUE) ~ "e",
                             grepl(paste(Settlement, collapse='|'), source_name, ignore.case = TRUE) ~ "f",
                             grepl(paste(O_LULUCF, collapse='|'), source_name, ignore.case = TRUE) ~ "g", 
                              .default = "")) %>%
  unite('ipcc_code2', c(ipcc_code, subcode), remove = FALSE, sep = "_") #combine IPCC code with subcode



#Add subsector into GHG_regions, match format, add more specific IPCC codes to join by
GHG_regions2 <- inner_join(IPCC_TES, GHG_regions,
	by=c("ipcc_code2", "ipcc_code")) %>% #use inner join to combine dataframes by shared variables
  rename("ghg_grouped" = "pollutant") %>% #rename variable to match UK only csv
  rename("nc_sector" = "nc_format") #rename variable




#Newest years only 
#UK-wide dataset
GHG_UK2022 <- GHG_UK22 %>%
  filter(year == "2022") #%>%
  #filter(tes_sector != "LULUCF") #filter out LULUCF to see if negative values impact things

GHG_UK2022pos <- GHG_UK2022 %>%
  filter(emissions_mt_co2e >= "0") #subset filter only positive values
  
#Regional dataset
GHG_regions2021 <- GHG_regions2 %>%
  filter(emission_year == "2021")

#Simplify
GHG_simp <- GHG_UK2022 %>%
  group_by(tes_sector, tes_subsector, category_2, category_1, activity) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
  replace(is.na(.), "") %>%
  filter(Temissions >= "0") #subset filter only positive values


```

## Visualization at High Level

```{r vis set up, warning=FALSE}

#Define custom color palette
colors <- paste(c('#40004b','#67001f','#b2182b','#dfc27d','#f6e8c3','#fddbc7','#fde0ef',
                  '#FF7E70','#2852A8','#DBB96E','#786EDB','#BD9DAC','#9C9075','#01665e','#6EDB93',
                  '#FF9C91','#FFD4E8','#CC995E','#FF8F99','#80AAFF',
                  '#6EDB70','#948B76','#D4B0C0','#BD5E53','#708670',
                  '#3D7EFF','#A496FF','#8C80DA','#62B2B5','#9E002F',
                  '#D90041','#FF2949','#58B059','#448745','#F5CE7A',
                  '#FFBF76','#7BE1E5','#7CF77E','#D4C39F','#FFEBBF','#536353'), collapse = '", "')

colorJS <- paste('d3.scaleOrdinal(["', colors, '"])') #format to call Javascript D3

```

### Sankey Diagram

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating proportional breakdown of greenhouse gas emissions in the UK in . From left to right, greenhouse gas by sector by subsector. Proportions based on megatonnesof CO2 equivalents."}

#Set up Sankey links dataframe - from subsector to sector to GHGs
links <- data.frame(source=c(paste0(GHG_UK2022$tes_subsector), paste0(GHG_UK2022$tes_sector)), 
                    target=c(paste0(GHG_UK2022$tes_sector), paste0(GHG_UK2022$ghg_grouped)),
                    value=as.numeric(paste0(GHG_UK2022$emissions_mt_co2e)))

links <- links[-c(1866:1893),] #remove instances with repeat name

#Create nodes df from names in links df
nodes <- data.frame(
  name=unique(c(as.character(links$source), 
  as.character(links$target))))

#Add ID numbers
links$IDsource <- as.numeric(match(links$source, nodes$name)-1)
links$IDtarget <- as.numeric(match(links$target, nodes$name)-1)

#Set up Sankey links dataframe - breakdown from GHGs to sectors to subsectors
links2 <- data.frame(source=c(paste0(GHG_UK2022$ghg_grouped), paste0(GHG_UK2022$tes_sector)), 
                    target=c(paste0(GHG_UK2022$tes_sector), paste0(GHG_UK2022$tes_subsector)),
                    value=as.numeric(paste0(GHG_UK2022$emissions_mt_co2e))) 

#links2 <- links2[-c(2317:3786),] #remove instances with repeat name
links2$target <- gsub("Waste", "Waste ", links2$target)

#Create nodes df from names in links df
nodes2 <- data.frame(
  name=unique(c(as.character(links2$source), 
  as.character(links2$target))))

#Add ID numbers
links2$IDsource <- as.numeric(match(links2$source, nodes2$name)-1)
links2$IDtarget <- as.numeric(match(links2$target, nodes2$name)-1)

#Plot with networkD3
sankey <- sankeyNetwork(Links = links2, Nodes = nodes2, #dataframes to use
              Source = "IDsource", Target = "IDtarget", #numeric identifiers of variables
              Value = "value", #numeric weights
							NodeID = "name", #node labels
              units = "Megatonnes CO2 eq.", #label units
							#colourScale = colorJS,
							fontSize = 7,
              sinksRight=FALSE, #justify last variables right if true
							nodePadding = 8, #vertical space between nodes
              iterations = 100) #number of times for it to try to find the best order and format

sankey #view plot


```

```{r, eval=FALSE, include=FALSE}

#Set up Sankey links dataframe - breakdown from GHGs to sectors to subsectors
links3 <- data.frame(source=c(paste0(GHG_simp$ghg_grouped), paste0(GHG_simp$tes_sector)), 
                    target=c(paste0(GHG_simp$tes_sector), paste0(GHG_simp$tes_subsector)),
                    value=as.numeric(paste0(GHG_simp$Temissions))) 

links3 <- links3[-c(1683:1710),] #remove instances with repeat name

#Create nodes df from names in links df
nodes3 <- data.frame(
  name=unique(c(as.character(links3$source), 
  as.character(links3$target))))

#Add ID numbers
links3$IDsource <- as.numeric(match(links3$source, nodes3$name)-1)
links3$IDtarget <- as.numeric(match(links3$target, nodes3$name)-1)

#Plot with Plotly
sankey2 <- plot_ly(type = "sankey",
                   domain = list(x =  c(0,1),y =  c(0,1)),
                   orientation = "h",
                   arrangement="snap", # can also change this to 'fixed'
                   valueformat = ".0f",
                   valuesuffix = "Mt CO2 eq.",
      node = list(
        label = nodes3$name,
        pad = 15,
        thickness = 20,
        line = list(color = "black", width = 0.5),
      link = list(
        source = links3$IDsource,
        target = links3$IDtarget,
        value = links3$value
        #label = linklist$label
        ))) %>% 
  layout(
    title = "Greenhouse Gas Emissions Per Sector in the UK",
    font = list(size = 10),
    xaxis = list(showgrid = F, zeroline = F),
    yaxis = list(showgrid = F, zeroline = F))

sankey2 #view

#Plot with Plotly and json file
sankey3 <- plot_ly(type = "sankey",
                   domain = list(x =  c(0,1),y =  c(0,1)),
                   orientation = "h",
                   arrangement="snap", # can also change this to 'fixed'
                   valueformat = ".0f",
                   valuesuffix = "Mt CO2 eq.",
      node = list(
        label = nodes3$name,
        pad = 15,
        thickness = 20,
        line = list(color = "black", width = 0.5),
      link = list(
        source = links3$IDsource,
        target = links3$IDtarget,
        value = GHGtree2022$value
        #label = linklist$label
        ))) %>% 
  layout(
    title = "Greenhouse Gas Emissions Per Sector in the UK",
    font = list(size = 10),
    xaxis = list(showgrid = F, zeroline = F),
    yaxis = list(showgrid = F, zeroline = F))


```

### Sunburst Diagram

```{r, eval=FALSE, include=FALSE}

#Try d3r make hierarchy json
GHGtree2022 <- d3_nest(GHG_simp, value_cols = "Temissions")

GHGtree2022

#Sunburst with sunburstR
sb1 <- sunburst(GHGtree2022, width="100%", height=400)
div(
  style="display: flex; align-items:center;",
  sb1
)


#Plotly
#Separate out variables summaries - all GHGs combined
sectors <- GHG_UK2022pos %>%
  group_by(tes_sector) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))

subsectors <- GHG_UK2022pos %>%
  group_by(tes_sector, tes_subsector) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))

cat_2 <- GHG_UK2022pos %>%
  group_by(tes_sector, tes_subsector, category_2) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))

cat_1 <- GHG_UK2022pos %>%
  group_by(tes_sector, tes_subsector, category_2, category_1) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))

activities <- GHG_UK2022pos %>%
  group_by(tes_sector, tes_subsector, category_2, category_1, activity) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))


#Now paste together distinct instances into dataframe with hierarchical structure - start simple
GHGsb <- data.frame(
  parents =c(rep("", 8), paste0(subsectors$tes_sector)),
  labels =c(paste0(sectors$tes_sector), paste0(subsectors$tes_subsector)),
  values =as.numeric(c(paste0(sectors$Temissions), paste0(subsectors$Temissions)))
)

#Add id column                    
GHGsb <- GHGsb %>%
          unite('ids', c(parents, labels), remove = FALSE, sep = " - ") #combine columns for id


sb <- plot_ly(GHGsb,
  type = 'sunburst',
  ids = ~ids,
  labels = ~labels,
  parents = ~parents,
  values = ~values,
  #branchvalues = 'total',
  insidetextorientation='radial'
) %>%
    layout(
      grid = list(columns =2, rows = 1),
      margin = list(l = 0, r = 0, b = 0, t = 0),
      sunburstcolorway = c(
        "#636efa","#EF553B","#00cc96","#ab63fa","#19d3f3",
        "#e763fa", "#FECB52","#FFA15A","#FF6692","#B6E880"
      ),
      extendsunburstcolors = TRUE)

sb


```

### Time Series Graph of Emissions by Sector

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Greenhouse gas emissions in megatonnesof CO2 equivalents in the UK over time, by sector."}

#Plot time series
Sect_time <- GHG_UK22 %>%
  group_by(year, tes_sector) %>%
  summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) %>%
  rename("Sector" = "tes_sector") %>% #rename variable
ggplot(aes(x=as.numeric(year), y=Temissions, color=Sector)) +
  geom_line() +
  xlab("") + ylab("Greenhouse Gas Emissions (Megatonnes CO2 eq.)") +
  ggtitle("Greenhouse Gas Emissions of the UK per Sector Over Time") +
  theme_few() +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = pretty(c(1990:2020), n=6)) +
  scale_color_brewer(palette = "Set2") +
  theme(legend.position="bottom")

#Sect_time #view ggplot

#Make interactive with Plotly
t_int <- plotly::ggplotly(Sect_time) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(t_int, hovertemplate="Year: %{x:,.r}
CO2eq: %{y:,.4r} kt") #define what hover label says, round x values, round y values to 4 sig. figs


```

## Sector and Subsector Summaries

### Agriculture

```{r, warning=FALSE}

ag_df <- GHG_UK2022 %>%
  filter(tes_sector == "Agriculture") %>% #filter sector
  replace(is.na(.), "")
  #group_by(tes_subsector, tes_category, source, ghg, ghg_grouped, ipcc_code) %>%
  #summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))

#wide - split GHGs
agwideGHG <- ag_df %>%
  pivot_wider(names_from = ghg_grouped, values_from=emissions_mt_co2e) %>%
  replace(is.na(.), 0)

```

#### Agriculture Sankey Diagram

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's agricultural sector in 2022."}

#Set up Sankey links dataframe
aglinks <- data.frame(source=c(paste0(ag_df$ghg_grouped), paste0(ag_df$tes_subsector), paste0(ag_df$category_2)), 
                    target=c(paste0(ag_df$tes_subsector), paste0(ag_df$category_2), paste0(ag_df$category_1)),
                    value=as.numeric(paste0(ag_df$emissions_mt_co2e)))

#Create nodes df from names in links df
agnodes <- data.frame(
  name=unique(c(as.character(aglinks$source), 
  as.character(aglinks$target))))

#Add ID numbers
aglinks$IDsource <- as.numeric(match(aglinks$source, agnodes$name)-1)
aglinks$IDtarget <- as.numeric(match(aglinks$target, agnodes$name)-1)


#Plot with networkD3
agsankey <- sankeyNetwork(Links = aglinks, Nodes = agnodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "Megatonnes CO2 eq.",
              sinksRight=FALSE, nodePadding = 8,
              iterations = 5)

agsankey

```

```{r, eval=FALSE, include=FALSE}


#Plot with Plotly
agsankey2 <- plot_ly(type = "sankey",
                   domain = list(x =  c(0,1),y =  c(0,1)),
                   orientation = "h",
                   valueformat = ".0f",
                   valuesuffix = "Mt CO2 eq.",
      node = list(
        label = agnodes$name,
        pad = 15,
        thickness = 20,
        line = list(color = "black", width = 0.5),
      link = list(
        source = aglinks$IDsource,
        target = aglinks$IDtarget,
        value = aglinks$value
        #label = linklist$label
        ))) %>% 
  layout(
    title = "Greenhouse Gas Emissions Per Agriculture Subsector in the UK",
    font = list(size = 10),
    xaxis = list(showgrid = F, zeroline = F),
    yaxis = list(showgrid = F, zeroline = F))

agsankey2


```

#### Agriculture Breakdown Graphs

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Doughnut charts of the UK's agriculture greenhouse gas emissions by greenhouse gas identity and subsector in 2022."}

agpie <- ag_df %>% plot_ly(textinfo = 'label', insidetextorientation='horizontal') %>%
  add_pie(labels = ~ghg, values = ~emissions_mt_co2e, hole = 0.6, domain = list(row = 0, column = 0)) %>% 
  add_pie(labels = ~tes_subsector, values = ~emissions_mt_co2e, hole = 0.6, domain = list(row = 0, column = 2)) %>% 
  layout(title = "Emissions by Greenhouse Gas Identity and Subsector",  showlegend = F,
         #annotations = list(list(x = 0.20 , y = 1, text = "Emissions by Greenhouse Gas Identity"), 
          #                  list(x = 0.80 , y = 1, text = "Emissions by Subsector")),
         grid=list(rows=1, columns=3),
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE)) 

style(agpie, hovertemplate="%{label} 
      Emissions: %{value:,.4r} Mt CO2 eq.
      %{percent}
      <extra></extra>")

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the UK's agriculture sector in 2022 by subsector, colored by greenhouse gas identity."}

#Bar plot by subsector, stacked by GHG
agbar <- ggplot(ag_df, aes(x = tes_subsector, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  xlab("Subsector") + ylab("Emissions (Mt CO2 eq.)") #define/change X and Y labels

#Make interactive with Plotly
agbar_int <- ggplotly(agbar) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(agbar_int, hovertemplate="Subsector: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the UK's agriculture sector in 2022 by category, colored by subsector."}

#Bar plot by source
agsource <- ggplot(ag_df, aes(x = category_1, y = emissions_mt_co2e, fill = tes_subsector)) + 
  geom_bar(stat = "identity", width = 0.7, position = "dodge") + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Agriculture emissions in 2022") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="top", legend.box = "horizontal",
        text=element_text(size=10, colour = "black"), axis.text.x=element_blank())
#axis.text.x = element_text(size=8, colour = "black")

#Make interactive with Plotly
agsource_int <- ggplotly(agsource) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agsource_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the UK's agricultural sector in  by category, colored by subsector and grouped by greenhouse gas identity."}

#Plot GHGs into side-by-side plots with Plotly
ag_CO2 <- agwideGHG %>% 
  plot_ly(x = ~tes_category, y = ~CO2, color = ~tes_subsector, type = 'bar', 
          legendgroup = ~tes_subsector) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

ag_CH4 <- agwideGHG %>% 
  plot_ly(x = ~tes_category, y = ~CH4, color = ~tes_subsector, type = 'bar', 
          legendgroup = ~tes_subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

ag_N2O <- agwideGHG %>% 
  plot_ly(x = ~tes_category, y = ~N2O, color = ~tes_subsector, type = 'bar', 
          legendgroup = ~tes_subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

ag_GHGs <- subplot(ag_CO2, ag_CH4, ag_N2O, shareY = FALSE, margin = 0.05) %>%
  layout(title = list(text = "UK's Agriculture Emissions in 2022", pad = list(t=50, b = 50)),
         yaxis = list(title = 'Emissions (Mt CO2 eq.)'), 
         plot_bgcolor='#e5ecf6',
         legend = list(orientation = "h", title=list(text='<b>Subsector</b>')),
         annotations = list(list(
           x = 0.125,  y = 1.0,
           text = "CO2",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.5,  y = 1.0,
           text = "CH4",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.875,  y = 1.0,
           text = "N2O",  
           xref = "paper",
           yref = "paper", 
           showarrow = FALSE)))

#Plotly customization
style(ag_GHGs, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs


```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the agricultural combustion subsector in 2022 by category, colored by greenhouse gas identity."}

#Bar plot combustion, stacked by GHG
agcom <- ag_df %>%
  filter(tes_subsector == "Agricultural combustion") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Agricultural Combustion") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agcom_int <- ggplotly(agcom) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agcom_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the agricultural soils subsector in 2022 by category, colored by greenhouse gas identity."}

#Bar plot soils, stacked by GHG
agsoil <- ag_df %>%
  filter(tes_subsector == "Agricultural soils") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Agricultural Soils") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agsoil_int <- ggplotly(agsoil) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agsoil_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs


```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the livestock subsector in 2022 by category, colored by greenhouse gas identity."}

#Bar plot livestock, stacked by GHG
agls <- ag_df %>%
  filter(tes_subsector == "Livestock") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Livestock") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agls_int <- ggplotly(agls) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agls_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the agricultural 'other' subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot other ag, stacked by GHG
agother <- ag_df %>%
  filter(tes_subsector == "Other agriculture") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Other Agriculture") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
agother_int <- ggplotly(agother) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(agother_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs
  
```

### LULUCF

Note - negative as well as positive values in this sector means some creative thinking is needed for visualization.

```{r, warning=FALSE}

LULUCF <- GHG_UK2022 %>%
  filter(tes_sector == "LULUCF") %>% #filter sector
  replace(is.na(.), "")
  #group_by(tes_subsector, tes_category, source, ghg, ghg_grouped, ipcc_code) %>%
  #summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))

#wide - split GHGs
LULUCFwideGHG <- LULUCF %>%
  pivot_wider(names_from = ghg, values_from=emissions_mt_co2e) %>%
  replace(is.na(.), 0)

```

#### LULUCF Sankey Diagram

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's LULUCF sector in 2022."}

#Set up Sankey links dataframe
LULUCFlinks <- data.frame(source=c(paste0(LULUCF$ghg)), 
                    target=c(paste0(LULUCF$tes_subsector)),
                    value=as.numeric(paste0(LULUCF$emissions_mt_co2e)))

#Create nodes df from names in links df
LULUCFnodes <- data.frame(
  name=unique(c(as.character(LULUCFlinks$source), 
  as.character(LULUCFlinks$target))))

#Add ID numbers
LULUCFlinks$IDsource <- as.numeric(match(LULUCFlinks$source, LULUCFnodes$name)-1)
LULUCFlinks$IDtarget <- as.numeric(match(LULUCFlinks$target, LULUCFnodes$name)-1)


#Plot with networkD3
LULUCFsankey <- sankeyNetwork(Links = LULUCFlinks, Nodes = LULUCFnodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "Mt CO2 eq.",
              sinksRight=TRUE, nodePadding = 30,
              iterations = 100)

LULUCFsankey

```

#### LULUCF Breakdown Graphs

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the UK's LULUCF sector in 2022 by subsector, colored by greenhouse gas identity."}

#Bar plot by subsector, stacked by GHG
LULUCFbar <- ggplot(LULUCF, aes(x = tes_subsector, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  xlab("Subsector") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(axis.text.x=element_blank())

#Make interactive with Plotly
LULUCFbar_int <- ggplotly(LULUCFbar) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(LULUCFbar_int, hovertemplate="Subsector: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs


```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the UK's LULUCF sector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot by source with Plotly
LULUCFsource <- LULUCFwideGHG %>% 
  plot_ly(x = ~category_1, y = ~CO2, type = 'bar', name = 'CO2') %>% 
  add_trace(y = ~CH4, name = 'CH4') %>%
  add_trace(y = ~N2O, name = 'N2O') %>%
  layout(barmode = 'stack', 
         title = list(text = "UK's LULUCF Emissions in 2022", pad = list(t=50, b=50)),
         yaxis = list(title = 'Emissions (Mt CO2 equivalents)'),
         xaxis = list(title = 'Source', showticklabels=FALSE))
         #legend = list(orientation = "h", title=list(text='<b>Subsector</b>')))

#Plotly customization
style(LULUCFsource, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") 

```

```{r, message=FALSE, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the UK's LULUCF sector in 2022 by source, colored by subsector and grouped by greenhouse gas identity."}

#Plot GHGs into side-by-side plots with Plotly
LULUCF_CO2 <- LULUCFwideGHG %>% 
  plot_ly(x = ~tes_category, y = ~CO2, color = ~tes_subsector, type = 'bar', legendgroup = ~tes_subsector) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

LULUCF_CH4 <- LULUCFwideGHG %>% 
  plot_ly(x = ~tes_category, y = ~CH4, color = ~tes_subsector, type = 'bar', legendgroup = ~tes_subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

LULUCF_N2O <- LULUCFwideGHG %>% 
  plot_ly(x = ~tes_category, y = ~N2O, color = ~tes_subsector, type = 'bar', legendgroup = ~tes_subsector, showlegend = F) %>%
  layout(xaxis = list(showticklabels=FALSE, showgrid = FALSE))

LULUCF_GHGs <- subplot(LULUCF_CO2, LULUCF_CH4, LULUCF_N2O, shareY = FALSE, margin = 0.05) %>%
  layout(title = list(text = "UK's LULUCF Emissions in 2022", pad = list(t=50, b = 50)),
         yaxis = list(title = 'Emissions (Mt CO2 equivalents)'), 
         plot_bgcolor='#e5ecf6',
         legend = list(orientation = "h", title=list(text='<b>Subsector</b>')),
         annotations = list(list(
           x = 0.125,  y = 1.0,
           text = "CO2",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.5,  y = 1.0,
           text = "CH4",  
           xref = "paper",
           yref = "paper",  
           showarrow = FALSE),  
           list(
           x = 0.875,  y = 1.0,
           text = "N2O",  
           xref = "paper",
           yref = "paper", 
           showarrow = FALSE)))

#Plotly customization
style(LULUCF_GHGs, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the bioenergy crops subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
biocrops <- LULUCF %>%
  filter(tes_subsector == "Bioenergy crops") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Bioenergy Crops") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
biocrops_int <- ggplotly(biocrops) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(biocrops_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the cropland mineral soils change subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
cropsoilchg <- LULUCF %>%
  filter(tes_subsector == "Cropland mineral soils change") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Cropland Mineral Soils Change") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
cropsoilchg_int <- ggplotly(cropsoilchg) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(cropsoilchg_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the grassland mineral soils change subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
grsoilchg <- LULUCF %>%
  filter(tes_subsector == "Grassland mineral soils change") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Grassland Mineral Soils Change") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
grsoilchg_int <- ggplotly(grsoilchg) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(grsoilchg_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the forestry subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
forestry <- LULUCF %>%
  filter(tes_subsector == "Forestry") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Forestry") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
forestry_int <- ggplotly(forestry) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(forestry_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the peatland subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
peat <- LULUCF %>%
  filter(tes_subsector == "Peatland") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Peatland") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
peat_int <- ggplotly(peat) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(peat_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnes of CO2 equivalents in the settlement subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot subsector, stacked by GHG
settle <- LULUCF %>%
  filter(tes_subsector == "Settlement") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Settlement") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
settle_int <- ggplotly(settle) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(settle_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

```{r, warning=FALSE, fig.align = "center", out.width = '65%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the 'other' LULUCF subsector in 2022 by source, colored by greenhouse gas identity."}

#Bar plot other ag, stacked by GHG
Lother <- LULUCF %>%
  filter(tes_subsector == "Other LULUCF") %>%
ggplot(aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  #scale_x_discrete(guide = guide_axis(angle = 45)) +
  ggtitle("Subsector Emissions in 2022: Other LULUCF") + #add a graph title
  xlab("") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="left", legend.box = "vertical", 
        axis.text.x=element_blank())
        #axis.text.x = element_text(size=8, colour = "black"))

#Make interactive with Plotly
Lother_int <- ggplotly(Lother) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h",
      xaxis = list(showticklabels=FALSE)))
  
#Plotly customization
style(Lother_int, 
hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs
  
```

### Waste

```{r, warning=FALSE}

waste_df <- GHG_UK2022 %>%
  filter(tes_sector == "Waste") %>% #filter sector
  replace(is.na(.), "")
  #group_by(tes_subsector, tes_category, source, ghg, ghg_grouped, ipcc_code) %>%
  #summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE))

#wide - split GHGs
waste_wideGHG <- waste_df %>%
  pivot_wider(names_from = ghg, values_from=emissions_mt_co2e) %>%
  replace(is.na(.), 0)

```

#### Waste Sankey Diagram

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's buildings and product uses sector in 2022."}

#Set up Sankey links dataframe
wastelinks <- data.frame(source=c(paste0(waste_df$ghg), paste0(waste_df$activity)), 
                    target=c(paste0(waste_df$activity), paste0(waste_df$source_1)),
                    value=as.numeric(paste0(waste_df$emissions_mt_co2e)))

#Create nodes df from names in links df
wastenodes <- data.frame(
  name=unique(c(as.character(wastelinks$source), 
  as.character(wastelinks$target))))

#Add ID numbers
wastelinks$IDsource <- as.numeric(match(wastelinks$source, wastenodes$name)-1)
wastelinks$IDtarget <- as.numeric(match(wastelinks$target, wastenodes$name)-1)


#Plot with networkD3
wastesankey <- sankeyNetwork(Links = wastelinks, Nodes = wastenodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "Mt CO2 eq.",
              sinksRight=FALSE, nodePadding = 8,
              iterations = 45)

wastesankey

```

#### Waste Breakdown Graphs

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Doughnut charts of the UK's waste greenhouse gas emissions by greenhouse gas identity and subsector in 2022."}

wastepie <- waste_df %>% plot_ly(textinfo = 'label', insidetextorientation='horizontal') %>%
  add_pie(labels = ~ghg, values = ~emissions_mt_co2e, hole = 0.6, domain = list(row = 0, column = 0)) %>% 
  add_pie(labels = ~tes_category, values = ~emissions_mt_co2e, hole = 0.6, domain = list(row = 0, column = 2)) %>% 
  layout(title = "Emissions by Greenhouse Gas Identity and Subsector",  showlegend = F,
         #annotations = list(list(x = 0.20 , y = 1, text = "Emissions by Greenhouse Gas Identity"), 
          #                  list(x = 0.80 , y = 1, text = "Emissions by Subsector")),
         grid=list(rows=1, columns=3),
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE)) 

style(wastepie, hovertemplate="%{label} 
      Emissions: %{value:,.4r} Mt CO2 eq.
      %{percent}
      <extra></extra>")

```

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Bar graph showing greenhouse gas emissions in megatonnesof CO2 equivalents in the UK's waste sector in 2022 by subsector, colored by greenhouse gas identity."}

#Bar plot by subsector, stacked by ghg
wastebar <- ggplot(waste_df, aes(x = tes_category, y = emissions_mt_co2e, fill = ghg)) + 
  geom_col() + 
  theme_few() + #remove grid, white background
  scale_fill_manual(values = wes_palette("GrandBudapest1")) +
  xlab("Source") + ylab("Emissions (Mt CO2 eq.)") + #define/change X and Y labels
  theme(legend.position="top", legend.box = "horizontal",
        text=element_text(size=10, colour = "black"), axis.text.x=element_blank())

#Make interactive with Plotly
wastebar_int <- ggplotly(wastebar) %>% #convert to interactive graph
  layout(legend = list(
      orientation = "h"))
  
#Plotly customization
style(wastebar_int, hovertemplate="Source: %{x}
Emissions: %{y:,.4r} Mt CO2 eq.") #define what hover label says, round x values, round y values to 4 sig. figs

```

### Buildings and product uses

```{r, warning=FALSE}

build_df <- GHG_UK22 %>%
  filter(tes_sector == "Buildings and product uses") %>% #filter sector
  replace(is.na(.), "")
  #group_by(tes_subsector, tes_category, source, ghg, ghg_grouped, ipcc_code) %>%
  #summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) 

#wide - split GHGs
build_wideGHG <- build_df %>%
  pivot_wider(names_from = ghg, values_from=emissions_mt_co2e) %>%
  replace(is.na(.), 0)

```

#### Buildings and Products Sankey Diagram

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's buildings and product uses sector in 2022."}

#Set up Sankey links dataframe
buildlinks <- data.frame(source=c(paste0(build_df$ghg), paste0(build_df$tes_subsector)), 
                    target=c(paste0(build_df$tes_subsector), paste0(build_df$source_1)),
                    value=as.numeric(paste0(build_df$emissions_mt_co2e)))

#Create nodes df from names in links df
buildnodes <- data.frame(
  name=unique(c(as.character(buildlinks$source), 
  as.character(buildlinks$target))))

#Add ID numbers
buildlinks$IDsource <- as.numeric(match(buildlinks$source, buildnodes$name)-1)
buildlinks$IDtarget <- as.numeric(match(buildlinks$target, buildnodes$name)-1)


#Plot with networkD3
buildsankey <- sankeyNetwork(Links = buildlinks, Nodes = buildnodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "Mt CO2 eq.",
              sinksRight=FALSE, nodePadding = 15,
              iterations = 15)

buildsankey

```

### Domestic transport

```{r, warning=FALSE}

transport <- GHG_UK22 %>%
  filter(tes_sector == "Domestic transport") %>% #filter sector
  replace(is.na(.), "")
  #group_by(tes_subsector, tes_category, source, ghg, ghg_grouped, ipcc_code) %>%
  #summarize(Temissions = sum(emissions_mt_co2e, na.rm = TRUE)) 

#wide - split GHGs
transport_wideGHG <- transport %>%
  pivot_wider(names_from = ghg, values_from=emissions_mt_co2e) %>%
  replace(is.na(.), 0)

```

#### Domestic Transport Sankey Diagram

```{r, warning=FALSE, fig.align = "center", out.width = '95%', fig.cap="Sankey diagram demonstrating breakdown of greenhouse gas emissions in the UK's transport sector in 2022."}

#Set up Sankey links dataframe
transportlinks <- data.frame(source=c(paste0(transport$ghg), paste0(transport$tes_subsector)), 
                    target=c(paste0(transport$tes_subsector), paste0(transport$tes_category)),
                    value=as.numeric(paste0(transport$emissions_mt_co2e)))

#Create nodes df from names in links df
transportnodes <- data.frame(
  name=unique(c(as.character(transportlinks$source), 
  as.character(transportlinks$target))))

#Add ID numbers
transportlinks$IDsource <- as.numeric(match(transportlinks$source, transportnodes$name)-1)
transportlinks$IDtarget <- as.numeric(match(transportlinks$target, transportnodes$name)-1)


#Plot with networkD3
transportsankey <- sankeyNetwork(Links = transportlinks, Nodes = transportnodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name",
              units = "Mt CO2 eq.",
              sinksRight=FALSE, nodePadding = 15,
              iterations = 15)

transportsankey

```
